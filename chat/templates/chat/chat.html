{% extends 'products/base.html' %}
{% load static %}

{% block title %}Чат с поддержкой{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-comments"></i> Чат с поддержкой
                        <span class="badge bg-light text-success ms-2">Онлайн</span>
                    </h5>
                </div>
                <div class="card-body p-0">
                    <!-- Область сообщений -->
                    <div id="chat-messages" class="chat-messages">
                        {% for message in messages %}
                            <div class="message {% if message.message_type == 'user' %}user-message{% else %}bot-message{% endif %}">
                                <div class="message-content">
                                    <div class="message-text">{{ message.content|linebreaks }}</div>
                                    <div class="message-time">{{ message.timestamp|date:"H:i" }}</div>
                                </div>
                            </div>
                        {% empty %}
                            <div class="welcome-message">
                                <div class="text-center p-4">
                                    <i class="fas fa-robot fa-3x text-success mb-3"></i>
                                    <h5>Добро пожаловать в чат поддержки!</h5>
                                    <p class="text-muted">Я помогу вам с любыми вопросами о товарах, доставке, оплате и других услугах.</p>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Форма отправки сообщения -->
                    <div class="chat-input">
                        <form id="chat-form" class="d-flex">
                            {% csrf_token %}
                            <input type="text" id="message-input" class="form-control" placeholder="Введите ваше сообщение..." autocomplete="off">
                            <button type="submit" class="btn btn-success ms-2">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.chat-messages {
    height: 400px;
    overflow-y: auto;
    padding: 20px;
    background-color: #f8f9fa;
}

.message {
    margin-bottom: 15px;
    display: flex;
}

.user-message {
    justify-content: flex-end;
}

.bot-message {
    justify-content: flex-start;
}

.message-content {
    max-width: 70%;
    padding: 10px 15px;
    border-radius: 18px;
    position: relative;
}

.user-message .message-content {
    background-color: #28a745;
    color: white;
    border-bottom-right-radius: 5px;
}

.bot-message .message-content {
    background-color: white;
    color: #333;
    border: 1px solid #dee2e6;
    border-bottom-left-radius: 5px;
}

.message-text {
    margin-bottom: 5px;
}

.message-time {
    font-size: 0.75rem;
    opacity: 0.7;
    text-align: right;
}

.bot-message .message-time {
    text-align: left;
}

.chat-input {
    padding: 15px;
    background-color: white;
    border-top: 1px solid #dee2e6;
}

.welcome-message {
    background-color: #d4edda;
    border-radius: 10px;
    margin: 20px;
}

#message-input:focus {
    border-color: #28a745;
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
}

/* Анимация появления сообщений */
.message {
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Скроллбар */
.chat-messages::-webkit-scrollbar {
    width: 6px;
}

.chat-messages::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.chat-messages::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.chat-messages::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const chatMessages = document.getElementById('chat-messages');
    
    // Автоскролл вниз
    function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Отправка сообщения
    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const message = messageInput.value.trim();
        if (!message) return;
        
        // Добавляем сообщение пользователя
        addMessage(message, 'user');
        messageInput.value = '';
        
        // Отправляем на сервер
        fetch('{% url "chat:send_message" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ message: message })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Добавляем ответ бота
                addMessage(data.bot_message.content, 'bot');
            } else {
                addMessage('Произошла ошибка. Попробуйте еще раз.', 'bot');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            addMessage('Произошла ошибка соединения.', 'bot');
        });
    });
    
    // Добавление сообщения в чат
    function addMessage(content, type) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}-message`;
        
        const now = new Date();
        const time = now.getHours().toString().padStart(2, '0') + ':' + 
                    now.getMinutes().toString().padStart(2, '0');
        
        messageDiv.innerHTML = `
            <div class="message-content">
                <div class="message-text">${content.replace(/\n/g, '<br>')}</div>
                <div class="message-time">${time}</div>
            </div>
        `;
        
        chatMessages.appendChild(messageDiv);
        scrollToBottom();
    }
    
    // Фокус на поле ввода
    messageInput.focus();
    
    // Скролл вниз при загрузке
    scrollToBottom();
});
</script>
{% endblock %}
