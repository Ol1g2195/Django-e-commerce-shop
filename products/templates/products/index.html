{% extends 'products/base.html' %}
{% load static %}
{{ test }}
{% block content %}
<!-- Баннер (слайдер) с автосменой -->
<div id="main-banner" class="mb-4">
    <div id="bannerCarousel" class="carousel slide" data-bs-ride="carousel" data-bs-interval="3500">
        <div class="carousel-inner">
            <div class="carousel-item active">
                <img src="{% static 'images/banners/bann1.png' %}" class="d-block w-100" alt="Баннер 1">
            </div>
            <div class="carousel-item">
                <img src="{% static 'images/banners/bann2.png' %}" class="d-block w-100" alt="Баннер 2">
            </div>
            <div class="carousel-item">
                <img src="{% static 'images/banners/bann3.png' %}" class="d-block w-100" alt="Баннер 3">
            </div>
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#bannerCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#bannerCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
        </button>
        <div class="carousel-indicators">
            <button type="button" data-bs-target="#bannerCarousel" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
            <button type="button" data-bs-target="#bannerCarousel" data-bs-slide-to="1" aria-label="Slide 2"></button>
            <button type="button" data-bs-target="#bannerCarousel" data-bs-slide-to="2" aria-label="Slide 3"></button>
        </div>
    </div>
</div>
<!-- /Баннер -->
<div class="container mt-4">
    <div class="row">
        <div class="col-md-3">
            <form method="get" id="filter-form">
                <div class="mb-3">
                    <input type="text" name="search" class="form-control" placeholder="Поиск товара..." value="{{ request.GET.search }}">
                </div>
                <div class="mb-3">
                    <select name="category" class="form-select" onchange="this.form.submit()">
                        <option value="">Выберите категорию</option>
                        {% for category in categories %}
                            <option value="{{ category.id }}" {% if request.GET.category == category.id|stringformat:'s' %}selected{% endif %}>{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label>Цена:</label>
                    <input type="number" name="min_price" class="form-control mb-1" placeholder="От" value="{{ request.GET.min_price }}">
                    <input type="number" name="max_price" class="form-control" placeholder="До" value="{{ request.GET.max_price }}">
                </div>
                <div class="mb-3">
                    <input type="checkbox" name="rating" value="4" id="rating-checkbox" {% if request.GET.rating %}checked{% endif %}>
                    <label for="rating-checkbox">Оценка 4 и выше</label>
                </div>
                <button type="submit" class="btn btn-success w-100">Фильтровать</button>
            </form>
        </div>
        <div class="col-md-9">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    {% for key, label in sort_options %}
                        {% if current_sort == key %}
                            {% if current_direction == 'asc' %}
                                {% with next_dir='desc' arrow='↑' %}
                                    <a href="?{% for k, v in request.GET.items %}{% if k != 'sort' and k != 'direction' %}{{ k }}={{ v|urlencode }}&{% endif %}{% endfor %}sort={{ key }}&direction={{ next_dir }}" class="btn btn-outline-secondary btn-sm active">
                                        Сортировать по {{ label }} {{ arrow }}
                                    </a>
                                {% endwith %}
                            {% else %}
                                {% with next_dir='asc' arrow='↓' %}
                                    <a href="?{% for k, v in request.GET.items %}{% if k != 'sort' and k != 'direction' %}{{ k }}={{ v|urlencode }}&{% endif %}{% endfor %}sort={{ key }}&direction={{ next_dir }}" class="btn btn-outline-secondary btn-sm active">
                                        Сортировать по {{ label }} {{ arrow }}
                                    </a>
                                {% endwith %}
                            {% endif %}
                        {% else %}
                            <a href="?{% for k, v in request.GET.items %}{% if k != 'sort' and k != 'direction' %}{{ k }}={{ v|urlencode }}&{% endif %}{% endfor %}sort={{ key }}&direction=desc" class="btn btn-outline-secondary btn-sm">
                                Сортировать по {{ label }}
                            </a>
                        {% endif %}
                    {% endfor %}
                </div>
                <div>
                    <button type="button" class="btn btn-outline-primary btn-sm me-1" id="grid-view-btn">Сетка</button>
                    <button type="button" class="btn btn-outline-primary btn-sm" id="list-view-btn">Список</button>
                </div>
            </div>
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
            <div class="row" id="product-list">
                {% for product in products %}
                <div class="col-md-4 mb-4 product-item">
                    <div class="card h-100">
                        <a href="{% url 'product_detail' product.id %}">
                            {% if product.image %}
                                <img src="{{ product.image.url }}" class="card-img-top" alt="{{ product.name }}">
                            {% else %}
                                <div class="no-image-placeholder">
                                    <p>{{ product.name }}</p>
                                </div>
                            {% endif %}
                        </a>
                        <div class="card-body">
                            <h5 class="card-title">
                                <a href="{% url 'product_detail' product.id %}" class="text-decoration-none text-dark">{{ product.name }}</a>
                            </h5>
                            <p class="card-text">Цена: {{ product.price }} ₽</p>
                            <p class="card-text">★ {{ product.average_rating|default:0|floatformat:1 }} ({{ product.review_count }})</p>
                            <div class="d-flex gap-2 mt-3">
                                {% if user.is_authenticated %}
                                    <form method="post" action="{% url 'add_to_cart' product.id %}" class="w-100">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-success btn-sm w-100">В корзину</button>
                                    </form>
                                {% else %}
                                    <a href="{% url 'users:login' %}" class="btn btn-outline-success btn-sm w-100">Войдите для покупки</a>
                                {% endif %}
                                <a href="{% url 'product_detail' product.id %}" class="btn btn-outline-primary btn-sm w-100">Подробнее</a>
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <p>Нет товаров по выбранным фильтрам.</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% block extra_js %}
<style>
/* Стили для режима списка */
#product-list.list-view .product-item {
    flex: 0 0 100%;
    max-width: 100%;
}
#product-list.list-view .card {
    flex-direction: row;
    align-items: center;
    min-height: 160px;
}
#product-list.list-view .card-img-top {
    width: 160px;
    height: 120px;
    object-fit: contain;
    margin-right: 24px;
    padding: 1rem;
}
#product-list.list-view .card-body {
    flex: 1 1 auto;
    padding: 1rem 1rem 1rem 0;
}

/* Стили для заглушки изображения */
.no-image-placeholder {
    background-color: #f8f9fa;
    height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 1rem;
    color: #6c757d;
    font-size: 1.1rem;
    border-bottom: 1px solid #dee2e6;
}

.no-image-placeholder p {
    margin: 0;
    word-break: break-word;
}

.card-img-top {
    height: 200px;
    object-fit: contain;
    background-color: #fff;
    padding: 1rem;
}
</style>
<script>
// Режимы отображения (сетка/список)
const gridBtn = document.getElementById('grid-view-btn');
const listBtn = document.getElementById('list-view-btn');
const productList = document.getElementById('product-list');
if (gridBtn && listBtn && productList) {
    gridBtn.onclick = function() {
        productList.classList.remove('list-view');
        localStorage.setItem('productViewMode', 'grid');
    };
    listBtn.onclick = function() {
        productList.classList.add('list-view');
        localStorage.setItem('productViewMode', 'list');
    };
    // Восстанавливаем режим отображения при загрузке страницы
    if (localStorage.getItem('productViewMode') === 'list') {
        productList.classList.add('list-view');
    }
}
</script>
{% endblock %}
{% endblock %} 